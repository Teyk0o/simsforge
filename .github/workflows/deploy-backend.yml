name: Deploy Backend to Production

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy from'
        required: false
        default: 'main'
        type: choice
        options:
          - main
          - develop
          - staging

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy Backend to Server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Display deployment info
        run: |
          echo "üöÄ Deploying from branch: ${{ github.event.inputs.branch || github.ref_name }}"
          echo "Trigger: ${{ github.event_name }}"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: 'backend/package-lock.json'

      - name: Install and build backend
        working-directory: ./backend
        run: |
          npm install
          npm run build

      - name: Create backend tarball with compiled modules
        run: tar -czf backend-deploy.tar.gz -C backend dist/ node_modules/ package.json package-lock.json

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Configure SSH known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Upload and deploy backend
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_PATH: /var/www/simsforge
        run: |
          scp backend-deploy.tar.gz ${SSH_USER}@${SSH_HOST}:/tmp/

          ssh ${SSH_USER}@${SSH_HOST} "export NVM_DIR=\$HOME/.nvm && \
          [ -s \"\$NVM_DIR/nvm.sh\" ] && . \"\$NVM_DIR/nvm.sh\" && \
          nvm use --lts && \
          mkdir -p ${DEPLOY_PATH}/api && \
          echo 'üìù Extracting new backend...' && \
          tar -xzf /tmp/backend-deploy.tar.gz -C ${DEPLOY_PATH}/api && \
          echo 'üîÑ Restarting service...' && \
          sudo systemctl restart simsforge-api && \
          echo '‚úÖ Service restarted successfully' && \
          sudo systemctl status simsforge-api && \
          rm /tmp/backend-deploy.tar.gz"

      - name: Deployment successful
        run: echo "‚úÖ Backend deployed successfully!"
