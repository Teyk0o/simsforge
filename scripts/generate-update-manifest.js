#!/usr/bin/env node

/**
 * Generate Tauri update manifest for GitHub Releases
 * This script creates a JSON file that tells Tauri where to find updates
 */

const fs = require('fs');
const path = require('path');

async function generateManifest() {
  try {
    // Read tauri config to get version
    const configPath = path.join(__dirname, '../app/src-tauri/tauri.conf.json');
    const config = JSON.parse(fs.readFileSync(configPath, 'utf8'));
    const version = config.version;
    const tag = `v${version}`;

    // Find the MSI file
    const bundleDir = path.join(__dirname, '../app/src-tauri/target/release/bundle/msi');
    const files = fs.readdirSync(bundleDir);
    const msiFile = files.find(f => f.endsWith('.msi'));

    // Read the signature file generated by Tauri signer
    let signature = '';
    if (msiFile) {
      const signaturePath = path.join(bundleDir, `${msiFile}.sig`);
      if (fs.existsSync(signaturePath)) {
        signature = fs.readFileSync(signaturePath, 'utf8').trim();
      } else {
        console.warn('Warning: signature file not found, manifest will have empty signature');
      }
    }

    if (!msiFile) {
      throw new Error('MSI file not found in bundle directory');
    }

    // GitHub repository info (you can override these with env vars)
    const owner = process.env.GITHUB_REPOSITORY_OWNER || 'teyk0o';
    const repo = process.env.GITHUB_REPOSITORY?.split('/')[1] || 'simsforge';
    const downloadUrl = `https://github.com/${owner}/${repo}/releases/download/${tag}/${msiFile}`;

    // Create manifest for windows-x86_64
    const manifest = {
      version: version,
      notes: `SimsForge ${version} - Auto-update release`,
      pub_date: new Date().toISOString(),
      platforms: {
        'windows-x86_64': {
          signature: signature,
          url: downloadUrl,
        },
      },
    };

    // Create output directory if it doesn't exist
    const outputDir = path.join(__dirname, '../updates');
    if (!fs.existsSync(outputDir)) {
      fs.mkdirSync(outputDir, { recursive: true });
    }

    // Write manifest file
    const outputPath = path.join(outputDir, 'latest.json');
    fs.writeFileSync(outputPath, JSON.stringify(manifest, null, 2));

    console.log(`✓ Update manifest generated: ${outputPath}`);
    console.log(`  Version: ${version}`);
    console.log(`  MSI: ${msiFile}`);
    console.log(`  URL: ${downloadUrl}`);
    console.log(`  Signature: ${signature ? signature.substring(0, 30) + '...' : 'NOT FOUND'}`);

  } catch (error) {
    console.error('✗ Failed to generate manifest:', error.message);
    process.exit(1);
  }
}

generateManifest();
